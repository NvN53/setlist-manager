<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SetDesk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="assets/manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="assets/icon-192.svg">
    <style>
        * { box-sizing: border-box; margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        body { max-width:500px; margin:0 auto; padding:20px; background-color:#f5f5f5; color:#333; }
        .app { background-color:white; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:15px; min-height:90vh; overflow: hidden; }
        .header { display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid #ddd; margin-bottom:10px; }
        .header h1 { margin:0; font-size:1.5rem; }
        .search-box { width:100%; padding:10px; margin:5px 0; border:1px solid #ddd; border-radius:6px; font-size:1rem; }
        .clear-search-btn { position:absolute; right:10px; top:50%; transform:translateY(-50%) translateY(-5px); background:none; border:none; font-size:1.2rem; cursor:pointer; color:#999; }
        .clear-search-btn:hover { color:#333; }
        .tabs { display:flex; margin:10px 0; border-bottom:1px solid #ddd; }
        .tab { flex:1; text-align:center; padding:12px; cursor:pointer; font-weight:bold; transition:all .3s; }
        .tab.active { border-bottom:3px solid #007bff; color:#007bff; }
        
        /* Fixed header layout for home pages */
        .home-header-fixed { position: sticky; top: 0; background: white; z-index: 10; padding: 10px 0 5px 0; }
        .home-content-scrollable { height: calc(100vh - 200px); overflow-y: auto; padding: 10px 0; }
        #lyrics-page .home-header-fixed { position: relative; /* NOT sticky */ background: white; z-index: 10; padding: 10px 0; }
        #lyrics-page .home-content-scrollable { flex: 1; overflow-y: auto; padding: 10px 0; }
        .song-item, .setlist-item { padding:15px 0; border-bottom:1px solid #eee; cursor:pointer; }
        .song-item:hover, .setlist-item:hover { background-color:#f9f9f9; }
        .song-title, .setlist-title { font-weight:bold; margin-bottom:5px; }
        .song-details, .setlist-details { color:#666; font-size:.9rem; }
        .setlist-song-item { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .setlist-song-info { flex-grow: 1; }
        .setlist-song-title { font-weight: bold; }
        .setlist-song-details { font-size: 0.8rem; color: #666; }
        .remove-song-btn { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2rem; }
        .view-setlist-song-item { padding: 15px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        .view-setlist-song-item:hover { background-color: #f9f9f9; }
        .available-song-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .available-song-item:hover { background-color: #f9f9f9; }
        .floating-button { position:fixed; bottom:30px; right:30px; width:60px; height:60px; border-radius:50%; background-color:#007bff; color:white; border:none; font-size:2rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; justify-content:center; align-items:center; }
        .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .menu-container { position: relative; }
        .menu-icon { cursor: pointer; padding: 10px; }
        .dropdown-menu { position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; min-width: 150px; }
        .menu-item { padding: 10px 15px; cursor: pointer; }
        .menu-item:hover { background-color: #f5f5f5; }
        .btn { padding:5px 10px; border:none; border-radius:4px; cursor:pointer; font-size:.8rem; transition:background-color .3s; }
        .btn-primary { background-color:#007bff; color:white; }
        .btn-secondary { background-color:#6c757d; color:white; }
        .btn-danger { background-color:#dc3545; color:white; }
        .form-group { margin-bottom:15px; text-align:left; }
        .form-group label { display:block; margin-bottom:5px; font-weight:bold; }
        .form-group input, .form-group select, .form-group textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:1rem; }
        .form-row { display:flex; gap:10px; }
        .form-row .form-group { flex:1; }
        .textarea-lyrics { min-height: calc(100vh - 300px); font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; overflow-x: hidden; word-wrap: break-word; }
        .action-buttons { display:flex; gap:10px; margin-top:20px; }
        .controls { display:flex; justify-content:space-between; align-items:center; margin:10px 0; flex-wrap:wrap; gap:10px; }
        .transpose-controls { display:flex; align-items:center; gap:10px; }
        .transpose-value { font-weight: bold; font-size: 1.1rem; min-width: 20px; text-align: center; }
        .transpose-btn { width:30px; height:30px; border-radius:50%; border:1px solid #ddd; background:white; cursor:pointer; font-size:1.6rem; }
        #metronome-toggle.btn.btn-secondary { background-color: #6c757d; color: white; border: none; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        
        body.dark-mode #metronome-toggle.btn.btn-secondary { background-color: #444; color: #ffffff; border: none; }
        
        body.dark-mode #metronome-toggle.btn.btn-secondary.active { background: #007bff; color: white; border: 1px solid #007bff; }
        #metronome-toggle.btn.btn-secondary:hover { background-color: #5a6268; }
        #metronome-toggle.btn.btn-secondary.active { color: #007bff; border: 1px solid #007bff; background-color: transparent; }
        .lyrics-container { text-align:left; white-space: pre-wrap; margin:10px 0; padding:5px 0; font-size:1rem; line-height:1.2; font-family: 'Courier New', Courier, monospace; color: inherit; overflow-x: hidden; word-wrap: break-word; }

        .lyrics-container:lang(ml) { font-size: 0.9rem; }
        /* Token approach styling */
        .token-row { line-height: 1; }
        .chord-token { font-weight: bold; color: #007bff; }
        .word-token { color: inherit; }
        .chord-line { margin-bottom:5px; font-weight:bold; color:#007bff; font-family: 'Courier New', Courier, monospace; white-space: pre; }
        .lyric-line { margin:5px 0 7px 0; line-height:1.2; font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; font-size:1rem; color: inherit; overflow-x: hidden; word-wrap: break-word; }
        .inline-chord-line .chord { background-color: rgba(0,123,255,0.1); padding:2px 4px; border-radius:3px; margin:0 2px; }
        .metadata { color:#6c757d; font-style:italic; margin:10px 0; padding:5px; background-color:#f8f9fa; border-left:3px solid #007bff; }
        .line-break { height:3px; }
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background-color:rgba(0,0,0,.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:white; padding:20px; border-radius:8px; max-width:90%; max-height:90%; overflow-y:auto; width:400px; }
        .pitch-btn { padding:8px 12px; margin:4px; border:1px solid #ddd; background:white; border-radius:4px; cursor:pointer; }
        .pitch-btn.active { background-color:#007bff; color:white; }
        
        /* Ambient pad modal styles */
        #tap-to-hum { width: 100%; padding: 12px; margin-bottom: 15px; }
        .mode-selection { display: flex; gap: 10px; }
        .mode-option { flex: 1; text-align: center; }
        
        /* Close button styles */
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: #333; 
            padding: 0; 
            width: auto; 
            height: auto; 
        }
        
        body.dark-mode .close-btn { 
            color: #fff; 
        }
        .hidden { display:none; }
        
        /* Settings page styles */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        /* Settings page positioning */
        #settings-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
        }
        
        #settings-page:not(.hidden) {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #settings-page .app {
            max-width: 500px;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            margin: 0 10px;
        }
        

        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #007bff;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        @media(max-width:500px){ body { padding:10px; } .app{ padding:15px } .form-row { flex-direction:column; gap:0; } }
        
        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        
        body.dark-mode .app {
            background-color: #1e1e1e;
            color: #ffffff;
        }
        
        body.dark-mode .header {
            border-bottom: 1px solid #444;
        }
        
        body.dark-mode .search-box {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #ffffff;
        }
        
        body.dark-mode .tabs {
            border-bottom: 1px solid #444;
        }
        
        body.dark-mode .tab {
            color: #cccccc;
        }
        
        body.dark-mode .tab.active {
            color: #ffffff;
            border-bottom: 3px solid #007bff;
        }
        
        body.dark-mode .song-item, 
        body.dark-mode .setlist-item {
            border-bottom: 1px solid #444;
        }
        
        body.dark-mode .song-item:hover, 
        body.dark-mode .setlist-item:hover {
            background-color: #2d2d2d;
        }
        
        body.dark-mode .view-setlist-song-item:hover {
            background-color: #2d2d2d;
        }
        
        body.dark-mode .song-details, 
        body.dark-mode .setlist-details {
            color: #aaaaaa;
        }
        
        body.dark-mode .form-group input, 
        body.dark-mode .form-group select, 
        body.dark-mode .form-group textarea {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #ffffff;
        }
        
        body.dark-mode .btn-secondary {
            background-color: #444;
            color: #ffffff;
        }
        
        body.dark-mode .btn-primary {
            background-color: #007bff;
            color: #ffffff;
        }
        
        body.dark-mode .btn-danger {
            background-color: #dc3545;
            color: #ffffff;
        }
        
        body.dark-mode .setting-item {
            border-bottom: 1px solid #444;
        }
        
        body.dark-mode .slider {
            background-color: #444;
        }
        
        body.dark-mode input:checked + .slider {
            background-color: #007bff;
        }
        
        body.dark-mode .home-header-fixed {
            background: #1e1e1e;
        }
        
        body.dark-mode #lyrics-page .home-header-fixed {
            background: #1e1e1e;
        }
        
        body.dark-mode .dropdown-menu {
            background-color: #2d2d2d;
            border: 1px solid #444;
        }
        
        body.dark-mode .menu-item:hover {
            background-color: #444;
        }
        
        body.dark-mode .modal-content {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode .pitch-btn {
            background-color: #444;
            color: #ffffff;
            border: 1px solid #555;
        }
        
        body.dark-mode .pitch-btn.active {
            background-color: #007bff;
        }
        
        body.dark-mode #settings-page {
            background: #1e1e1e;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Home Page - Songs -->
        <div id="home-songs-page">
            <div class="home-header-fixed">
                <div class="header">
                    <h1>SetDesk</h1>
                    <div class="menu-container">
                        <i class="fas fa-ellipsis-v menu-icon"></i>
                        <div class="dropdown-menu hidden">
                            <div class="menu-item" id="settings-menu-item">Settings</div>
                        </div>
                    </div>
                </div>
                <div class="search-box-container">
                    <input type="text" placeholder="Search" class="search-box" id="song-search">
                    <button class="clear-search-btn hidden" id="clear-song-search">×</button>
                </div>
                <div class="tabs">
                    <div class="tab active" id="songs-tab">SONGS</div>
                    <div class="tab" id="setlists-tab">SETLISTS</div>
                </div>
            </div>
            <div class="home-content-scrollable">
                <div id="songs-list"></div>
            </div>
            <button class="floating-button" id="add-song-btn">+</button>
        </div>

        <!-- Home Page - Setlists -->
        <div id="home-setlists-page" class="hidden">
            <div class="home-header-fixed">
                <div class="header">
                    <h1>SetDesk</h1>
                    <div class="menu-container">
                        <i class="fas fa-ellipsis-v menu-icon"></i>
                        <div class="dropdown-menu hidden">
                            <div class="menu-item" id="settings-menu-item-2">Settings</div>
                        </div>
                    </div>
                </div>
                <div class="search-box-container">
                    <input type="text" placeholder="Search" class="search-box" id="setlist-search">
                    <button class="clear-search-btn hidden" id="clear-setlist-search">×</button>
                </div>
                <div class="tabs">
                    <div class="tab" id="back-to-songs-tab">SONGS</div>
                    <div class="tab active" id="setlists-tab-active">SETLISTS</div>
                </div>
            </div>
            <div class="home-content-scrollable">
                <div id="setlists-list"></div>
            </div>
            <button class="floating-button" id="add-setlist-btn">+</button>
        </div>

        <!-- View Setlist Page -->
        <div id="view-setlist-page" class="hidden">
            <div class="page-header">
                <button class="btn btn-secondary" id="back-to-setlists-from-view"><i class="fas fa-arrow-left"></i></button>
                <h2 id="view-setlist-title">Setlist Title</h2>
                <div class="menu-container">
                    <i class="fas fa-ellipsis-v menu-icon"></i>
                    <div class="dropdown-menu hidden">
                        <div class="menu-item" id="edit-setlist-menu-item">Edit Setlist</div>
                    </div>
                </div>
            </div>

            <div id="view-setlist-songs-container">
                <!-- Songs in setlist will be dynamically added here -->
            </div>
        </div>

        <!-- Edit Setlist Page -->
        <div id="edit-setlist-page" class="hidden">
            <div class="page-header">
                <button class="btn btn-secondary" id="cancel-edit-setlist-btn"><i class="fas fa-arrow-left"></i></button>
                <h2 id="edit-setlist-title">Edit Setlist</h2>
                <button class="btn btn-primary" id="save-setlist-btn">Save</button>
            </div>

            <div class="form-group">
                <label>Setlist Title</label>
                <input type="text" id="setlist-title" placeholder="Setlist title">
            </div>

            <div class="form-group">
                <label>Songs in Setlist</label>
                <div id="setlist-songs-container">
                    <!-- Songs will be dynamically added here -->
                </div>
            </div>

            <div class="form-group">
                <label>Add Songs</label>
                <div class="search-box-container">
                    <input type="text" placeholder="Search songs" class="search-box" id="add-song-search">
                    <button class="clear-search-btn hidden" id="clear-add-song-search">×</button>
                </div>
                <div id="available-songs-list">
                    <!-- Available songs will be listed here -->
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-danger" id="delete-setlist-btn">Delete Setlist</button>
            </div>
        </div>

        <!-- Edit Song Page -->
        <div id="edit-song-page" class="hidden">
            <div class="page-header">
                <button class="btn btn-secondary" id="cancel-edit-btn"><i class="fas fa-arrow-left"></i></button>
                <h2>Edit Song</h2>
                <button class="btn btn-primary" id="save-song-btn">Save</button>
            </div>

            <div class="form-group">
                <label>Title</label>
                <input type="text" id="song-title" placeholder="Song title">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Key</label>
                    <select id="song-key">
                        <option value="C">C</option><option value="C#">C#</option><option value="D">D</option><option value="D#">D#</option><option value="E">E</option><option value="F">F</option><option value="F#">F#</option><option value="G">G</option><option value="G#">G#</option><option value="A">A</option><option value="A#">A#</option><option value="B">B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mode</label>
                    <select id="song-mode">
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>BPM</label>
                    <input type="number" id="song-bpm" min="20" max="300" value="120">
                </div>
                <div class="form-group">
                    <label>Time Sig</label>
                    <select id="song-time-sig">
                        <option value="2/4">2/4</option><option value="3/4">3/4</option><option value="4/4" selected>4/4</option><option value="6/8">6/8</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Lyrics & Chords</label>
                <textarea class="textarea-lyrics" id="song-lyrics" placeholder="Enter lyrics and chords here..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn btn-danger" id="delete-song-btn">Delete Song</button>
                <button class="btn btn-secondary" id="duplicate-song-btn">Duplicate Song</button>
            </div>
        </div>

        <!-- Lyrics Page -->
        <div id="lyrics-page" class="hidden">
            <div class="home-header-fixed">
                <div class="page-header">
                    <button class="btn btn-secondary" id="back-to-songs-from-lyrics"><i class="fas fa-arrow-left"></i></button>
                    <h2 id="lyrics-title">Song Title</h2>
                    <div class="menu-container">
                        <i class="fas fa-ellipsis-v menu-icon"></i>
                        <div class="dropdown-menu hidden">
                            <div class="menu-item" id="edit-song-menu-item">Edit Song</div>
                            <div class="menu-item" id="delete-song-menu-item">Delete Song</div>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons" style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <button class="btn btn-secondary" id="prev-song-btn" style="display: none;"><i class="fas fa-arrow-left"></i> Previous</button>
                    <button class="btn btn-secondary" id="next-song-btn" style="display: none;">Next <i class="fas fa-arrow-right"></i></button>
                </div>

                <div class="song-details" id="lyrics-details" style="margin: 5px 0;">Key • BPM bpm</div>

                <div class="controls">
                    <button class="btn btn-secondary" id="ambient-btn" style="font-size: 0.8rem; padding: 5px 10px;">Ambient</button>
                    <div class="metronome-controls" style="display: flex; align-items: center; gap: 8px;">
                        <button id="metronome-toggle" class="btn btn-secondary" style="font-size: 0.8rem; padding: 5px 10px; display: flex; align-items: center; justify-content: center;">Metronome</button>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="font-size: 0.8rem; margin: 0;">Autoscroll:</label>
                            <button id="autoscroll-toggle" class="btn btn-secondary" style="font-size: 0.8rem; padding: 3px 8px; min-width: 40px;">Off</button>
                            <select id="autoscroll-level" style="font-size: 0.8rem; padding: 3px;" disabled>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                    </div>
                    <div class="transpose-controls">
                        <button class="transpose-btn" id="transpose-down-lyrics" style="width: 30px; height: 30px; font-size: 0.8rem;">-</button>
                        <span class="transpose-value" id="transpose-value">0</span>
                        <button class="transpose-btn" id="transpose-up-lyrics" style="width: 30px; height: 30px; font-size: 0.8rem;">+</button>
                    </div>
                </div>
            </div>

            <div class="home-content-scrollable">
                <div class="lyrics-container" id="lyrics-content"></div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings-page" class="hidden">
            <div class="app">
                <div class="page-header">
                    <button class="btn btn-secondary" id="back-to-home-from-settings"><i class="fas fa-arrow-left"></i></button>
                    <h2>Settings</h2>
                    <div></div> <!-- Spacer for flex alignment -->
                </div>

                <div class="form-group">
                    <label>Appearance</label>
                    <div class="setting-item">
                        <span>Dark Mode</span>
                        <label class="switch">
                            <input type="checkbox" id="dark-mode-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Metronome Volume</label>
                    <input type="range" min="0" max="100" value="50" class="volume-slider" id="metronome-volume">
                    <div class="volume-label">Volume: <span id="metronome-volume-value">50</span>%</div>
                </div>
            </div>
        </div>

        <!-- Ambient Pad Modal -->
        <div id="ambient-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="page-header">
                    <h2>Ambient Pad</h2>
                    <button class="close-btn" id="close-ambient-modal"><i class="fas fa-times"></i></button>
                </div>

                <div class="form-group">
                    <label>Pitch Finder</label>
                    <button class="btn btn-secondary" id="tap-to-hum"><i class="fas fa-microphone"></i> Tap to hum</button>
                    <div>Detected pitch: <span id="detected-pitch">G#</span></div>
                </div>

                <div class="form-group">
                    <label>Mode</label>
                    <div class="mode-selection">
                        <div class="mode-option">
                            <button class="btn pitch-btn" data-mode="major">Major</button>
                        </div>
                        <div class="mode-option">
                            <button class="btn pitch-btn" data-mode="minor">Minor</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Pitch</label>
                    <div id="pitch-buttons"></div>
                </div>

                <div class="form-group">
                    <label>Volume</label>
                    <input type="range" min="0" max="100" value="50" class="volume-slider" id="volume-slider">
                </div>
            </div>
        </div>
    </div>

<script>
/* ---------- data & startup (unchanged) ---------- */
let songs = JSON.parse(localStorage.getItem('setlistManager_songs')) || [
    { id: 1, title: 'Amazing Grace', key: 'G', bpm: 78, timeSig: '4/4', lyrics: 'G\nAmazing grace, how sweet the sound\nG           C\nThat saved a wretch like me\nG               Em\nI once was lost, but now am found\nG       D          G\nWas blind, but now I see' },
    { id: 2, title: 'Hallelujah', key: 'C', bpm: 68, timeSig: '4/4', lyrics: 'C                    Am\nI\'ve heard there was a secret chord\nF                      C\nThat David played and it pleased the Lord\nG                      Em\nBut you don\'t really care for music, do ya?\nF           C          G\nIt goes like this the fourth, the fifth\nAm                 F\nThe minor fall, the major lift\nG              Em         Am\nThe baffled king composing Hallelujah' },
    { id: 3, title: 'Ente Daivame', key: 'Fm', bpm: 92, timeSig: '4/4', lyrics: 'Fm              C\nEnte daivame nee thanne\nFm              C\nEnte sakhavum nee thanne\nDm              Fm\nEnte snehithanum nee thanne\nC               Fm\nEnikku vendiyavanum nee thanne' }
];
let setlists = JSON.parse(localStorage.getItem('setlistManager_setlists')) || [
    { id: 1, title: 'Sunday Service – Jan 12', songIds: [1, 2] },
    { id: 2, title: 'Christmas Eve Mass', songIds: [2, 3] },
    { id: 3, title: 'Malayalam Choir Practice', songIds: [3, 1] }
];

// Load metronome sound
function loadMetronomeSound() {
    const request = new XMLHttpRequest();
    request.open('GET', 'assets/audio/metronome.wav', true);
    request.responseType = 'arraybuffer';
    
    request.onload = function() {
        if (!audioContext) {
            console.warn('Audio context not available yet');
            return;
        }
        
        audioContext.decodeAudioData(request.response, function(buffer) {
            metronomeBuffer = buffer;
        }, function(error) {
            console.error('Error decoding metronome sound:', error);
        });
    };
    
    request.onerror = function() {
        console.error('Error loading metronome sound');
    };
    
    request.send();
}

// Create audio context and load metronome sound on first user interaction
let audioContextCreated = false;
document.body.addEventListener('click', function initAudio() {
    if (!audioContextCreated) {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            loadMetronomeSound();
            audioContextCreated = true;
        } catch (e) {
            console.error('Web Audio API is not supported in this browser', e);
        }
    }
}, { once: true });

let currentSong = null;
let currentSetlist = null;
let editingSongId = null;
let editingSetlistId = null;
let cameFromViewSetlist = false;
let transposeValue = 0;
let metronomeBuffer = null;
let metronomeVolume = 50; // Default volume (0-100)
 
/* ---------- elements ---------- */
const homeSongsPage = document.getElementById('home-songs-page');
const homeSetlistsPage = document.getElementById('home-setlists-page');
const editSongPage = document.getElementById('edit-song-page');
const editSetlistPage = document.getElementById('edit-setlist-page');
const viewSetlistPage = document.getElementById('view-setlist-page');
const lyricsPage = document.getElementById('lyrics-page');
const settingsPage = document.getElementById('settings-page');
const ambientModal = document.getElementById('ambient-modal');

/* ---------- events ---------- */
document.getElementById('songs-tab').addEventListener('click', showSongsPage);
document.getElementById('setlists-tab').addEventListener('click', showSetlistsPage);
document.getElementById('setlists-tab-active').addEventListener('click', showSetlistsPage);
document.getElementById('back-to-songs-tab').addEventListener('click', showSongsPage);
document.getElementById('back-to-songs-from-lyrics').addEventListener('click', function() {
    // Turn off metronome when exiting lyrics page
    const metronomeBtn = document.getElementById('metronome-toggle');
    if (metronomeBtn && metronomeBtn.classList.contains('active')) {
        metronomeBtn.classList.remove('active');
        console.log('Metronome OFF');
    }
    
    if (currentSetlist && window.currentSetlistContext) {
        showViewSetlistPage(currentSetlist);
    } else {
        showSongsPage();
    }
});
document.getElementById('back-to-setlists-from-view').addEventListener('click', function() {
    // Turn off metronome when exiting lyrics page
    const metronomeBtn = document.getElementById('metronome-toggle');
    if (metronomeBtn && metronomeBtn.classList.contains('active')) {
        metronomeBtn.classList.remove('active');
        console.log('Metronome OFF');
    }
    showSetlistsPage();
});
document.getElementById('back-to-home-from-settings').addEventListener('click', showSongsPage);
document.getElementById('prev-song-btn').addEventListener('click', navigateToPrevSong);
document.getElementById('next-song-btn').addEventListener('click', navigateToNextSong);

// Menu functionality for lyrics page
document.querySelector('#lyrics-page .menu-icon').addEventListener('click', function(e) {
    e.stopPropagation();
    document.querySelector('#lyrics-page .dropdown-menu').classList.toggle('hidden');
});

// Menu functionality for view setlist page
document.querySelectorAll('#view-setlist-page .menu-icon')[0].addEventListener('click', function(e) {
    e.stopPropagation();
    const dropdown = e.target.closest('.menu-container').querySelector('.dropdown-menu');
    dropdown.classList.toggle('hidden');
});

document.getElementById('edit-song-menu-item').addEventListener('click', function() {
    if (currentSong) {
        editSong(currentSong);
    }
    document.querySelector('.dropdown-menu').classList.add('hidden');
});

document.getElementById('delete-song-menu-item').addEventListener('click', function() {
    if (currentSong && confirm('Are you sure you want to delete this song?')) {
        songs = songs.filter(s => s.id !== currentSong.id);
        localStorage.setItem('setlistManager_songs', JSON.stringify(songs));
        renderSongsList();
        showSongsPage();
    }
    document.querySelector('.dropdown-menu').classList.add('hidden');
});

// Close menu when clicking elsewhere
document.addEventListener('click', function(e) {
    if (!e.target.closest('.menu-container')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.add('hidden');
        });
    }
});

// Edit setlist menu item
document.getElementById('edit-setlist-menu-item').addEventListener('click', function() {
    if (currentSetlist) {
        showEditSetlistPage(currentSetlist, true);
    }
    document.querySelector('.dropdown-menu').classList.add('hidden');
});

// Home page menu items
// Songs page menu items
document.getElementById('settings-menu-item').addEventListener('click', function() {
    showSettingsPage();
    document.querySelector('.dropdown-menu').classList.add('hidden');
});

// Setlists page menu items
document.getElementById('settings-menu-item-2').addEventListener('click', function() {
    showSettingsPage();
    document.querySelector('.dropdown-menu').classList.add('hidden');
});

document.getElementById('add-song-btn').addEventListener('click', createNewSong);
document.getElementById('cancel-edit-btn').addEventListener('click', function() {
    if (window.fromLyricsPage && currentSong) {
        // Go back to the lyrics page
        showLyricsPage(currentSong);
        window.fromLyricsPage = false;
    } else {
        // Go back to the songs page
        showSongsPage();
    }
});
document.getElementById('save-song-btn').addEventListener('click', saveSong);
document.getElementById('delete-song-btn').addEventListener('click', deleteSong);
document.getElementById('duplicate-song-btn').addEventListener('click', duplicateSong);

document.getElementById('cancel-edit-setlist-btn').addEventListener('click', function() {
  if (cameFromViewSetlist && currentSetlist) {
    showViewSetlistPage(currentSetlist);
  } else {
    showSetlistsPage();
  }
});
document.getElementById('save-setlist-btn').addEventListener('click', saveSetlist);
document.getElementById('delete-setlist-btn').addEventListener('click', deleteSetlist);

document.getElementById('ambient-btn').addEventListener('click', showAmbientPad);
document.getElementById('close-ambient-modal').addEventListener('click', hideAmbientPad);

document.getElementById('tap-to-hum').addEventListener('click', function() {
    // Simulate pitch detection
    const pitches = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const randomPitch = pitches[Math.floor(Math.random() * pitches.length)];
    document.getElementById('detected-pitch').textContent = randomPitch;
});

// Mode selection buttons
const modeButtons = document.querySelectorAll('[data-mode]');
modeButtons.forEach(button => {
    button.addEventListener('click', function() {
        // Remove active class from all buttons
        modeButtons.forEach(btn => btn.classList.remove('active'));
        // Add active class to clicked button
        this.classList.add('active');
        // Store selected mode
        const selectedMode = this.getAttribute('data-mode');
        console.log('Selected mode:', selectedMode);
    });
});
document.getElementById('song-search').addEventListener('input', filterSongs);
document.getElementById('setlist-search').addEventListener('input', filterSetlists);
document.getElementById('add-song-search').addEventListener('input', filterAvailableSongs);

// Clear search button functionality
document.getElementById('clear-song-search').addEventListener('click', function() {
    document.getElementById('song-search').value = '';
    filterSongs();
    this.classList.add('hidden');
});

document.getElementById('clear-setlist-search').addEventListener('click', function() {
    document.getElementById('setlist-search').value = '';
    filterSetlists();
    this.classList.add('hidden');
});

document.getElementById('clear-add-song-search').addEventListener('click', function() {
    document.getElementById('add-song-search').value = '';
    filterAvailableSongs();
    this.classList.add('hidden');
});

document.getElementById('dark-mode-toggle').addEventListener('change', function() {
    const isDarkMode = this.checked;
    // Save preference to localStorage
    localStorage.setItem('setlistManager_darkMode', isDarkMode);
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
});

// Metronome volume control
const metronomeVolumeSlider = document.getElementById('metronome-volume');
const metronomeVolumeValue = document.getElementById('metronome-volume-value');
if (metronomeVolumeSlider && metronomeVolumeValue) {
    metronomeVolumeSlider.addEventListener('input', function() {
        metronomeVolume = parseInt(this.value);
        metronomeVolumeValue.textContent = metronomeVolume;
        // Save preference to localStorage
        localStorage.setItem('setlistManager_metronomeVolume', metronomeVolume);
    });
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', function() {
    renderSongsList();
    renderSetlistsList();
    renderPitchButtons();
    document.getElementById('add-setlist-btn').addEventListener('click', createNewSetlist);
    const metronomeBtn = document.getElementById('metronome-toggle');
    if (metronomeBtn) metronomeBtn.addEventListener('click', toggleMetronome);
    const transposeUpBtn = document.getElementById('transpose-up-lyrics');
    const transposeDownBtn = document.getElementById('transpose-down-lyrics');
    if (transposeUpBtn && transposeDownBtn) {
        transposeUpBtn.addEventListener('click', () => transposeLyrics(1));
        transposeDownBtn.addEventListener('click', () => transposeLyrics(-1));
    }
    
    // Load dark mode preference
    const savedDarkMode = localStorage.getItem('setlistManager_darkMode') === 'true';
    if (savedDarkMode) {
        document.body.classList.add('dark-mode');
        // Update toggle switch state
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        if (darkModeToggle) {
            darkModeToggle.checked = true;
        }
    }
    
    // Load metronome volume preference
    const savedMetronomeVolume = localStorage.getItem('setlistManager_metronomeVolume');
    if (savedMetronomeVolume !== null) {
        metronomeVolume = parseInt(savedMetronomeVolume);
        const metronomeVolumeSlider = document.getElementById('metronome-volume');
        const metronomeVolumeValue = document.getElementById('metronome-volume-value');
        if (metronomeVolumeSlider && metronomeVolumeValue) {
            metronomeVolumeSlider.value = metronomeVolume;
            metronomeVolumeValue.textContent = metronomeVolume;
        }
    }
    
    // Initialize default mode selection for ambient pad
    const majorButton = document.querySelector('[data-mode="major"]');
    if (majorButton) {
        majorButton.classList.add('active');
    }
    
    // Autoscroll functionality
    const autoscrollToggle = document.getElementById('autoscroll-toggle');
    const autoscrollLevel = document.getElementById('autoscroll-level');
    
    if (autoscrollToggle && autoscrollLevel) {
        // Toggle autoscroll on/off
        autoscrollToggle.addEventListener('click', function() {
            const isOn = this.textContent === 'On';
            if (isOn) {
                // Turn off
                this.textContent = 'Off';
                this.classList.remove('btn-primary');
                this.classList.add('btn-secondary');
                autoscrollLevel.disabled = true;
                stopAutoscroll();
            } else {
                // Turn on
                this.textContent = 'On';
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary');
                autoscrollLevel.disabled = false;
                const level = parseInt(autoscrollLevel.value);
                startAutoscroll(level);
            }
        });
        
        // Change autoscroll level
        autoscrollLevel.addEventListener('change', function() {
            if (autoscrollToggle.textContent === 'On') {
                const level = parseInt(this.value);
                stopAutoscroll();
                startAutoscroll(level);
            }
        });
    }
    
    // Home page menu functionality
    // Using a more direct approach to ensure the menu works
    document.addEventListener('click', function(e) {
        // Handle songs page menu
        if (e.target.closest('#home-songs-page .menu-icon')) {
            e.stopPropagation();
            const menuContainer = e.target.closest('#home-songs-page .menu-container');
            const dropdown = menuContainer ? menuContainer.querySelector('.dropdown-menu') : null;
            if (dropdown) {
                // Close all other menus first
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu !== dropdown) {
                        menu.classList.add('hidden');
                    }
                });
                dropdown.classList.toggle('hidden');
            }
        }
        
        // Handle setlists page menu
        if (e.target.closest('#home-setlists-page .menu-icon')) {
            e.stopPropagation();
            const menuContainer = e.target.closest('#home-setlists-page .menu-container');
            const dropdown = menuContainer ? menuContainer.querySelector('.dropdown-menu') : null;
            if (dropdown) {
                // Close all other menus first
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu !== dropdown) {
                        menu.classList.add('hidden');
                    }
                });
                dropdown.classList.toggle('hidden');
            }
        }
    });
});

/* ---------- navigation ---------- */
function showSongsPage() { 
    // Turn off metronome when exiting lyrics page
    stopMetronome();
    const metronomeBtn = document.getElementById('metronome-toggle');
    if (metronomeBtn && metronomeBtn.classList.contains('active')) {
        metronomeBtn.classList.remove('active');
    }
    stopAutoscroll(); homeSongsPage.classList.remove('hidden'); homeSetlistsPage.classList.add('hidden'); editSongPage.classList.add('hidden'); editSetlistPage.classList.add('hidden'); viewSetlistPage.classList.add('hidden'); lyricsPage.classList.add('hidden'); settingsPage.classList.add('hidden'); ambientModal.classList.add('hidden'); clearSetlistContext(); }
function showSetlistsPage() { 
    // Turn off metronome when exiting lyrics page
    stopMetronome();
    const metronomeBtn = document.getElementById('metronome-toggle');
    if (metronomeBtn && metronomeBtn.classList.contains('active')) {
        metronomeBtn.classList.remove('active');
    }
    stopAutoscroll(); homeSongsPage.classList.add('hidden'); homeSetlistsPage.classList.remove('hidden'); editSongPage.classList.add('hidden'); editSetlistPage.classList.add('hidden'); viewSetlistPage.classList.add('hidden'); lyricsPage.classList.add('hidden'); settingsPage.classList.add('hidden'); ambientModal.classList.add('hidden'); clearSetlistContext(); }
function showViewSetlistPage(setlist) { stopMetronome(); stopAutoscroll(); homeSongsPage.classList.add('hidden'); homeSetlistsPage.classList.add('hidden'); editSongPage.classList.add('hidden'); editSetlistPage.classList.add('hidden'); viewSetlistPage.classList.remove('hidden'); lyricsPage.classList.add('hidden'); settingsPage.classList.add('hidden'); ambientModal.classList.add('hidden'); currentSetlist = setlist; document.getElementById('view-setlist-title').textContent = setlist.title; renderViewSetlistSongs(setlist.songIds); }
function showEditSongPage(song = null) {
    stopMetronome(); stopAutoscroll(); homeSongsPage.classList.add('hidden'); homeSetlistsPage.classList.add('hidden'); editSongPage.classList.remove('hidden'); editSetlistPage.classList.add('hidden'); lyricsPage.classList.add('hidden'); settingsPage.classList.add('hidden'); ambientModal.classList.add('hidden');
    if (song) {
        editingSongId = song.id;
        document.getElementById('song-title').value = song.title;
        
        // Parse key to separate key and mode
        let key = song.key;
        let mode = 'major';
        if (key.endsWith('m')) {
            key = key.substring(0, key.length - 1); // Remove 'm'
            mode = 'minor';
        }
        
        document.getElementById('song-key').value = key;
        document.getElementById('song-mode').value = mode;
        document.getElementById('song-bpm').value = song.bpm;
        document.getElementById('song-time-sig').value = song.timeSig;
        document.getElementById('song-lyrics').value = song.lyrics;
        document.getElementById('delete-song-btn').style.display = 'block';
    } else {
        editingSongId = null;
        document.getElementById('song-title').value = '';
        document.getElementById('song-key').value = 'C';
        document.getElementById('song-mode').value = 'major';
        document.getElementById('song-bpm').value = 120;
        document.getElementById('song-time-sig').value = '4/4';
        document.getElementById('song-lyrics').value = '';
        document.getElementById('delete-song-btn').style.display = 'none';
    }
}
function showLyricsPage(song) {
    stopMetronome();
    stopAutoscroll();
    // Reset autoscroll controls when showing a new song
    const autoscrollToggle = document.getElementById('autoscroll-toggle');
    const autoscrollLevel = document.getElementById('autoscroll-level');
    if (autoscrollToggle) {
        autoscrollToggle.textContent = 'Off';
        autoscrollToggle.classList.remove('btn-primary');
        autoscrollToggle.classList.add('btn-secondary');
    }
    if (autoscrollLevel) {
        autoscrollLevel.value = '1';
        autoscrollLevel.disabled = true;
    }
    
    homeSongsPage.classList.add('hidden'); homeSetlistsPage.classList.add('hidden'); editSongPage.classList.add('hidden'); editSetlistPage.classList.add('hidden'); viewSetlistPage.classList.add('hidden'); lyricsPage.classList.remove('hidden'); settingsPage.classList.add('hidden'); ambientModal.classList.add('hidden');
    
    // Reset transpose value when showing a new song
    transposeValue = 0;
    // Display with + prefix for positive values
    document.getElementById('transpose-value').textContent = (transposeValue > 0 ? '+' : '') + transposeValue;
    
    currentSong = songs.find(s => s.id === song.id) || song;
    document.getElementById('lyrics-title').textContent = currentSong.title;
    document.getElementById('lyrics-details').textContent = `${currentSong.key} • ${currentSong.bpm} bpm`;
    
    // Set language attribute for Malayalam songs
    const lyricsContainer = document.getElementById('lyrics-content');
    if (currentSong.title.includes('Malayalam') || /[ഀ-ൿ]/.test(currentSong.lyrics)) {
        lyricsContainer.setAttribute('lang', 'ml');
    } else {
        lyricsContainer.removeAttribute('lang');
    }
    
    document.getElementById('lyrics-content').innerHTML = renderLyricsWithChords(currentSong.lyrics);
    // Hide navigation buttons by default
    document.getElementById('prev-song-btn').style.display = 'none';
    document.getElementById('next-song-btn').style.display = 'none';
}

function showLyricsPageFromSetlist(song, songIds, currentIndex) {
    stopMetronome();
    stopAutoscroll();
    // Reset autoscroll controls when showing a new song
    const autoscrollToggle = document.getElementById('autoscroll-toggle');
    const autoscrollLevel = document.getElementById('autoscroll-level');
    if (autoscrollToggle) {
        autoscrollToggle.textContent = 'Off';
        autoscrollToggle.classList.remove('btn-primary');
        autoscrollToggle.classList.add('btn-secondary');
    }
    if (autoscrollLevel) {
        autoscrollLevel.value = '1';
        autoscrollLevel.disabled = true;
    }
    
    homeSongsPage.classList.add('hidden'); homeSetlistsPage.classList.add('hidden'); editSongPage.classList.add('hidden'); editSetlistPage.classList.add('hidden'); viewSetlistPage.classList.add('hidden'); lyricsPage.classList.remove('hidden'); settingsPage.classList.add('hidden'); ambientModal.classList.add('hidden');
    
    // Reset transpose value when showing a new song
    transposeValue = 0;
    // Display with + prefix for positive values
    document.getElementById('transpose-value').textContent = (transposeValue > 0 ? '+' : '') + transposeValue;
    
    currentSong = songs.find(s => s.id === song.id) || song;
    document.getElementById('lyrics-title').textContent = currentSong.title;
    document.getElementById('lyrics-details').textContent = `${currentSong.key} • ${currentSong.bpm} bpm`;
    
    // Set language attribute for Malayalam songs
    const lyricsContainer = document.getElementById('lyrics-content');
    if (currentSong.title.includes('Malayalam') || /[ഀ-ൿ]/.test(currentSong.lyrics)) {
        lyricsContainer.setAttribute('lang', 'ml');
    } else {
        lyricsContainer.removeAttribute('lang');
    }
    
    document.getElementById('lyrics-content').innerHTML = renderLyricsWithChords(currentSong.lyrics);
    
    // Show navigation buttons with appropriate styling
    const prevBtn = document.getElementById('prev-song-btn');
    const nextBtn = document.getElementById('next-song-btn');
    
    // Reset button styles
    prevBtn.style.opacity = '1';
    prevBtn.style.pointerEvents = 'auto';
    nextBtn.style.opacity = '1';
    nextBtn.style.pointerEvents = 'auto';
    
    // Show/hide and fade buttons based on position
    if (currentIndex > 0) {
        prevBtn.style.display = 'block';
    } else {
        prevBtn.style.display = 'block';
        prevBtn.style.opacity = '0.5';
        prevBtn.style.pointerEvents = 'none';
    }
    
    if (currentIndex < songIds.length - 1) {
        nextBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        nextBtn.style.opacity = '0.5';
        nextBtn.style.pointerEvents = 'none';
    }
    
    // Store current setlist context for navigation
    window.currentSetlistContext = { songIds, currentIndex };
}
function showAmbientPad(){ ambientModal.classList.remove('hidden'); }
function hideAmbientPad(){ ambientModal.classList.add('hidden'); }

function showSettingsPage() {
    // Turn off metronome when exiting lyrics page
    stopMetronome();
    const metronomeBtn = document.getElementById('metronome-toggle');
    if (metronomeBtn && metronomeBtn.classList.contains('active')) {
        metronomeBtn.classList.remove('active');
    }
    
    // Hide all other pages
    homeSongsPage.classList.add('hidden');
    homeSetlistsPage.classList.add('hidden');
    editSongPage.classList.add('hidden');
    editSetlistPage.classList.add('hidden');
    viewSetlistPage.classList.add('hidden');
    lyricsPage.classList.add('hidden');
    ambientModal.classList.add('hidden');
    
    // Show settings page
    settingsPage.classList.remove('hidden');
}

function clearSetlistContext() {
    currentSetlist = null;
    window.currentSetlistContext = null;
}

function navigateToPrevSong() {
    if (window.currentSetlistContext) {
        const { songIds, currentIndex } = window.currentSetlistContext;
        if (currentIndex > 0) {
            const prevIndex = currentIndex - 1;
            const prevSongId = songIds[prevIndex];
            const prevSong = songs.find(s => s.id === prevSongId);
            if (prevSong) {
                showLyricsPageFromSetlist(prevSong, songIds, prevIndex);
            }
        } else {
            // Already at the first song, fade the button
            const prevBtn = document.getElementById('prev-song-btn');
            prevBtn.style.opacity = '0.5';
            prevBtn.style.pointerEvents = 'none';
        }
    }
}

function navigateToNextSong() {
    if (window.currentSetlistContext) {
        const { songIds, currentIndex } = window.currentSetlistContext;
        if (currentIndex < songIds.length - 1) {
            const nextIndex = currentIndex + 1;
            const nextSongId = songIds[nextIndex];
            const nextSong = songs.find(s => s.id === nextSongId);
            if (nextSong) {
                showLyricsPageFromSetlist(nextSong, songIds, nextIndex);
            }
        } else {
            // Already at the last song, fade the button
            const nextBtn = document.getElementById('next-song-btn');
            nextBtn.style.opacity = '0.5';
            nextBtn.style.pointerEvents = 'none';
        }
    }
}

/* ---------- small utilities ---------- */
function isChordToken(tok) {
    return /^[A-G][#b]?(m|dim|aug|sus|Maj|min|\+|°)?(\/[A-G][#b]?)?$/.test(tok);
}

/* ---------- rendering lists ---------- */
function renderSongsList(filteredSongs = null) {
    const songsList = document.getElementById('songs-list');
    const songsToRender = filteredSongs || songs;
    songsList.innerHTML = songsToRender.map(song => `
        <div class="song-item" data-id="${song.id}">
            <div class="song-title">${song.title}</div>
            <div class="song-details">${song.key} • ${song.bpm} bpm</div>
        </div>
    `).join('');
    document.querySelectorAll('.song-item').forEach(item => {
        item.addEventListener('click', () => {
            const songId = parseInt(item.getAttribute('data-id'));
            const song = songs.find(s => s.id === songId);
            if (song) showLyricsPage(song);
        });
    });
}

function renderSetlistsList(filteredSetlists = null) {
    const setlistsList = document.getElementById('setlists-list');
    const setlistsToRender = filteredSetlists || setlists;
    setlistsList.innerHTML = setlistsToRender.map(setlist => {
        // Calculate actual song count
        const songCount = setlist.songIds ? setlist.songIds.length : 0;
        return `
        <div class="setlist-item" data-id="${setlist.id}">
            <div class="setlist-title">${setlist.title}</div>
            <div class="setlist-details">${songCount} songs</div>
        </div>`;
    }).join('');
    document.querySelectorAll('.setlist-item').forEach(item => {
        item.addEventListener('click', () => {
            const setlistId = parseInt(item.getAttribute('data-id'));
            const setlist = setlists.find(s => s.id === setlistId);
            if (setlist) showViewSetlistPage(setlist);
        });
    });
}

/* ---------- ambient UI ---------- */
function renderPitchButtons() {
    const pitches = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const container = document.getElementById('pitch-buttons');
    container.innerHTML = pitches.map(p => `<button class="pitch-btn ${p==='G#'?'active':''}" data-pitch="${p}">${p}</button>`).join('');
    document.querySelectorAll('.pitch-btn').forEach(b => {
        b.addEventListener('click', () => {
            document.querySelectorAll('.pitch-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            document.getElementById('detected-pitch').textContent = b.getAttribute('data-pitch');
        });
    });
}

/* ---------- filters ---------- */
function filterSongs() {
    const searchTerm = document.getElementById('song-search').value.toLowerCase();
    const filteredSongs = songs.filter(song => song.title.toLowerCase().includes(searchTerm));
    renderSongsList(filteredSongs);
    
    // Show/hide clear button
    const clearBtn = document.getElementById('clear-song-search');
    if (searchTerm.length > 0) {
        clearBtn.classList.remove('hidden');
    } else {
        clearBtn.classList.add('hidden');
    }
}
function filterSetlists() {
    const searchTerm = document.getElementById('setlist-search').value.toLowerCase();
    const filteredSetlists = setlists.filter(setlist => setlist.title.toLowerCase().includes(searchTerm));
    renderSetlistsList(filteredSetlists);
    
    // Show/hide clear button
    const clearBtn = document.getElementById('clear-setlist-search');
    if (searchTerm.length > 0) {
        clearBtn.classList.remove('hidden');
    } else {
        clearBtn.classList.add('hidden');
    }
}

function filterAvailableSongs() {
    const searchTerm = document.getElementById('add-song-search').value.toLowerCase();
    const filteredSongs = songs.filter(song => song.title.toLowerCase().includes(searchTerm));
    renderAvailableSongs(filteredSongs);
    
    // Show/hide clear button
    const clearBtn = document.getElementById('clear-add-song-search');
    if (searchTerm.length > 0) {
        clearBtn.classList.remove('hidden');
    } else {
        clearBtn.classList.add('hidden');
    }
}

/* ---------- chord/lyrics parsing & rendering (FIXED) ---------- */

/*
  Approach:
  - parseChordProInline(line): converts a chord-pro inline line into tokens {text, chord?}
  - renderTokenLine(tokens): renders HTML where each word is a .token with chord above
  - renderLyricsWithChords: handles detection of chord-only lines -> attaches to next lyric line
*/

function parseChordProInline(line) {
    // convert \r removed already in caller
    // mark chords with special delimiters then split
    const MARK = '\u0007';
    let s = line.replace(/\[([^\]]+)\]/g, (m, p1) => `${MARK}${p1}${MARK}`);
    // also accept (C) style
    s = s.replace(/\(([^\)]+)\)/g, (m, p1) => `${MARK}${p1}${MARK}`);
    const raw = s.split(/\s+/).filter(Boolean);
    const tokens = [];
    let pendingChord = undefined;
    for (const r of raw) {
        const chordOnly = r.match(/^\u0007(.+)\u0007$/);
        if (chordOnly) {
            pendingChord = chordOnly[1];
            continue;
        }
        // embedded markers
        const embedded = /^(?:\u0007(.+)\u0007)?(.+?)(?:\u0007(.+)\u0007)?$/.exec(r);
        if (embedded) {
            const leftChord = embedded[1];
            const word = embedded[2];
            const rightChord = embedded[3];
            if (leftChord) {
                tokens.push({ text: word, chord: leftChord });
            } else if (pendingChord) {
                tokens.push({ text: word, chord: pendingChord });
                pendingChord = undefined;
            } else {
                tokens.push({ text: word, chord: undefined });
            }
            if (rightChord) pendingChord = rightChord;
        } else {
            tokens.push({ text: r, chord: pendingChord });
            pendingChord = undefined;
        }
    }
    return tokens;
}

function renderTokenLine(tokens) {
    // tokens: [{text, chord?}, ...]
    // Create a container with two rows rendered as inline-block tokens
    // Use min-width in ch units so short words don't collapse and chords keep spacing
    const htmlParts = [];
    htmlParts.push('<div class="token-row" style="line-height: 1;">');
    for (let i = 0; i < tokens.length; i++) {
        const t = tokens[i];
        // escape HTML
        const chord = t.chord ? escapeHtml(t.chord) : '&nbsp;';
        // Use fixed width based on text length to ensure consistent spacing
        const width = Math.max(2, t.text.length);
        htmlParts.push(`<span class="token" style="display:inline-block; width:${width}ch; text-align:center; vertical-align:top;"><span class="chord-token" style="display:block; color:#007bff; font-weight:700; margin-bottom:1px; font-size:.9rem;">${chord}</span><span class="word-token" style="display:block; white-space:nowrap; font-family:'Courier New',Courier,monospace; font-size:1rem; color:inherit;">${escapeHtml(t.text)}</span></span>`);
    }
    htmlParts.push('</div>');
    return htmlParts.join('');
}

function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderLyricsWithChords(lyrics) {
    if (!lyrics) return '';
    // Simply display the lyrics as they are, preserving all formatting
    return escapeHtml(lyrics).replace(/\n/g, '<br>');
}

/* ---------- transpose (unchanged) ---------- */
function transposeSingleChord(chord, noteIndex, notes, steps) {
    const match = chord.match(/^([A-G][#b]?)(.*)$/);
    if (!match) return chord;
    let baseNote = match[1];
    const suffix = match[2] || '';
    // map flats to sharps for consistency
    const flats = { 'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#' };
    if (flats[baseNote]) baseNote = flats[baseNote];
    const currentIndex = noteIndex[baseNote];
    if (currentIndex === undefined) return chord;
    const newIndex = (currentIndex + steps + 12) % 12;
    const newNote = notes[newIndex];
    return newNote + suffix;
}

function transposeLyrics(steps) {
    if (!currentSong) return;
    
    // Update transpose value
    transposeValue += steps;
    // Display with + prefix for positive values
    document.getElementById('transpose-value').textContent = (transposeValue > 0 ? '+' : '') + transposeValue;
    
    const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const noteIndex = {}; notes.forEach((n,i) => noteIndex[n]=i);
    const keyMatch = currentSong.key.match(/^([A-G][#b]?)(.*)$/);
    if (!keyMatch) return;
    const baseNote = keyMatch[1]; const suffix = keyMatch[2] || '';
    const currentIndex = noteIndex[baseNote]; if (currentIndex === undefined) return;
    const newIndex = (currentIndex + steps + 12) % 12; const newNote = notes[newIndex];
    currentSong.key = newNote + suffix;
    document.getElementById('lyrics-details').textContent = `${currentSong.key} • ${currentSong.bpm} bpm`;
    currentSong.lyrics = transposeLyricsContent(currentSong.lyrics, steps, noteIndex, notes);
    document.getElementById('lyrics-content').innerHTML = renderLyricsWithChords(currentSong.lyrics);
    console.log(`Transposed key to ${newNote}${suffix}`);
}

function transposeLyricsContent(lyrics, steps, noteIndex, notes) {
    if (!lyrics) return lyrics;
    return lyrics.split('\n').map(line => {
        if (line.includes('[') && line.includes(']')) {
            return line.replace(/\[([A-G][#b]?(m|dim|aug|sus|Maj|min|\+|°)?(\/[A-G][#b]?)?)\]/g, (m,chord) => {
                return `[${transposeSingleChord(chord, noteIndex, notes, steps)}]`;
            });
        } else if (line.includes('(') && line.includes(')')) {
            return line.replace(/\(([A-G][#b]?(m|dim|aug|sus|Maj|min|\+|°)?(\/[A-G][#b]?)?)\)/g, (m,chord) => {
                return `(${transposeSingleChord(chord, noteIndex, notes, steps)})`;
            });
        } else if (/^([A-G][#b]?(m|dim|aug|sus|Maj|min|\+|°)?(\/[A-G][#b]?)?\s*)+$/.test(line.trim())) {
            return line.replace(/([A-G][#b]?(m|dim|aug|sus|Maj|min|\+|°)?(\/[A-G][#b]?)?)/g, (m) => transposeSingleChord(m, noteIndex, notes, steps));
        }
        return line;
    }).join('\n');
}



/* ---------- autoscroll ---------- */
let autoscrollInterval = null;

function startAutoscroll(speed) {
    // Clear any existing autoscroll interval
    if (autoscrollInterval) {
        clearInterval(autoscrollInterval);
        autoscrollInterval = null;
    }
    
    // Check if autoscroll is enabled
    const autoscrollToggle = document.getElementById('autoscroll-toggle');
    if (!autoscrollToggle || autoscrollToggle.textContent !== 'On') return;
    
    // Get the scrollable content area
    const scrollableArea = document.querySelector('#lyrics-page .home-content-scrollable');
    if (!scrollableArea) return;
    
    // Calculate scroll speed - slower for lower values
    // Speed 1: extremely slow (0.5 pixels every 100ms)
    // Speed 2: very slow (1 pixel every 100ms)
    // Speed 3: slow (2 pixels every 100ms)
    // Speed 4: medium (4 pixels every 100ms)
    const pixelsPerStep = speed === 1 ? 0.5 : Math.pow(2, speed - 2);
    
    // Start autoscroll interval
    autoscrollInterval = setInterval(() => {
        scrollableArea.scrollBy(0, pixelsPerStep);
        
        // Stop when we reach the bottom
        if (scrollableArea.scrollTop + scrollableArea.clientHeight >= scrollableArea.scrollHeight) {
            clearInterval(autoscrollInterval);
            autoscrollInterval = null;
            // Reset the autoscroll toggle to Off
            if (autoscrollToggle) {
                autoscrollToggle.textContent = 'Off';
                autoscrollToggle.classList.remove('btn-primary');
                autoscrollToggle.classList.add('btn-secondary');
            }
            // Disable the level selector
            const autoscrollLevel = document.getElementById('autoscroll-level');
            if (autoscrollLevel) {
                autoscrollLevel.disabled = true;
            }
        }
    }, 100); // Scroll every 100ms for smooth movement
}

function stopAutoscroll() {
    if (autoscrollInterval) {
        clearInterval(autoscrollInterval);
        autoscrollInterval = null;
    }
}

/* ---------- song CRUD ---------- */
function createNewSong() { showEditSongPage(); }

/* ---------- setlist CRUD ---------- */
// Open the setlist editor to create a new setlist
function createNewSetlist() {
  showEditSetlistPage(null);
}

// Show the setlist editor (editing existing setlist or creating new)
function showEditSetlistPage(setlist = null, fromViewSetlist = false) {
  homeSongsPage.classList.add('hidden');
  homeSetlistsPage.classList.add('hidden');
  editSongPage.classList.add('hidden');
  editSetlistPage.classList.remove('hidden');
  viewSetlistPage.classList.add('hidden');
  lyricsPage.classList.add('hidden');
  settingsPage.classList.add('hidden');
  ambientModal.classList.add('hidden');
  cameFromViewSetlist = fromViewSetlist;

  // clear search box for available songs
  const addSearch = document.getElementById('add-song-search');
  if (addSearch) addSearch.value = '';

  if (setlist) {
    // Editing existing setlist
    document.getElementById('edit-setlist-title').textContent = 'Edit Setlist';
    document.getElementById('setlist-title').value = setlist.title;
    editingSetlistId = setlist.id;

    // Render songs in setlist
    renderSetlistSongs(setlist.songIds);

    // Show delete button
    document.getElementById('delete-setlist-btn').style.display = 'block';
  } else {
    // Creating new setlist
    document.getElementById('edit-setlist-title').textContent = 'New Setlist';
    document.getElementById('setlist-title').value = '';
    editingSetlistId = null;

    // Clear songs in setlist
    document.getElementById('setlist-songs-container').innerHTML = '';

    // Hide delete button
    document.getElementById('delete-setlist-btn').style.display = 'none';
  }

  // Render available songs and wire search
  renderAvailableSongs();
}

// Save the setlist to storage (new or existing)
function saveSetlist() {
  const title = document.getElementById('setlist-title').value.trim();
  if (!title) {
    alert('Please enter a setlist title');
    return;
  }

  // Collect song IDs from the setlist container (in order)
  const songIds = [];
  document.querySelectorAll('.setlist-song-item').forEach(item => {
    const id = parseInt(item.getAttribute('data-song-id'));
    if (!isNaN(id)) songIds.push(id);
  });

  if (editingSetlistId) {
    // Update existing
    const index = setlists.findIndex(s => s.id === editingSetlistId);
    if (index !== -1) {
      setlists[index] = { id: editingSetlistId, title, songIds };
    }
  } else {
    // Create new
    const newSetlist = { id: Date.now(), title, songIds };
    setlists.push(newSetlist);
  }

  localStorage.setItem('setlistManager_setlists', JSON.stringify(setlists));
  renderSetlistsList();
  
  // Navigate back appropriately
  if (cameFromViewSetlist && editingSetlistId) {
    // Find the updated setlist and show it
    const updatedSetlist = setlists.find(s => s.id === editingSetlistId);
    if (updatedSetlist) {
      showViewSetlistPage(updatedSetlist);
    } else {
      showSetlistsPage();
    }
  } else {
    showSetlistsPage();
  }
}

// Delete setlist (already wired to button)
function deleteSetlist() {
  if (editingSetlistId && confirm('Are you sure you want to delete this setlist?')) {
    setlists = setlists.filter(s => s.id !== editingSetlistId);
    localStorage.setItem('setlistManager_setlists', JSON.stringify(setlists));
    renderSetlistsList();
      
    // Navigate back appropriately
    if (cameFromViewSetlist) {
      showSetlistsPage();
    } else {
      showSetlistsPage();
    }
  }
}

/* Render the songs currently in the setlist editor.
   Provides drag handle, up/down, and remove controls.
*/
function renderSetlistSongs(songIds) {
  const container = document.getElementById('setlist-songs-container');
  container.innerHTML = '';
}

function renderViewSetlistSongs(songIds) {
  const container = document.getElementById('view-setlist-songs-container');
  container.innerHTML = '';

  // Build DOM elements in order
  songIds.forEach((songId, index) => {
    const song = songs.find(s => s.id === songId);
    if (!song) return;

    const el = document.createElement('div');
    el.className = 'view-setlist-song-item';
    el.setAttribute('data-song-id', songId);
    el.setAttribute('data-index', index);

    el.innerHTML = `
      <div class="song-title">${escapeHtml(song.title)}</div>
      <div class="song-details">${escapeHtml(song.key)} • ${song.bpm} bpm</div>
    `;

    el.addEventListener('click', () => {
      showLyricsPageFromSetlist(song, songIds, index);
    });

    container.appendChild(el);
  });
}

function renderSetlistSongs(songIds) {
  const container = document.getElementById('setlist-songs-container');
  container.innerHTML = '';

  // Build DOM elements in order
  songIds.forEach((songId, index) => {
    const song = songs.find(s => s.id === songId);
    if (!song) return;

    const el = document.createElement('div');
    el.className = 'setlist-song-item';
    el.setAttribute('data-song-id', songId);
    el.setAttribute('draggable', 'true');

    el.innerHTML = `
      <div class="setlist-song-info" style="display:flex;align-items:center;gap:10px;">
        <span class="drag-handle" title="Drag to reorder" style="cursor:grab;">☰</span>
        <div style="min-width:0">
          <div class="setlist-song-title">${escapeHtml(song.title)}</div>
          <div class="setlist-song-details">${escapeHtml(song.key)} • ${song.bpm} bpm</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="remove-song-btn" title="Remove">×</button>
      </div>
    `;

    // Drag and drop is the primary way to reorder

    // remove handler
    el.querySelector('.remove-song-btn').addEventListener('click', () => {
      el.remove();
      
      // Update the setlist data in localStorage
      const newSongIds = Array.from(container.children).map(ch => parseInt(ch.getAttribute('data-song-id')));
      
      // Update the setlist in the global setlists array
      if (editingSetlistId) {
        const index = setlists.findIndex(s => s.id === editingSetlistId);
        if (index !== -1) {
          setlists[index].songIds = newSongIds;
          // Save to localStorage
          localStorage.setItem('setlistManager_setlists', JSON.stringify(setlists));
        }
      }
      
      // Refresh the available songs list to show the newly removed song
      renderAvailableSongs();
    });

    // Drag and drop handlers
    el.addEventListener('dragstart', (ev) => {
      ev.dataTransfer.setData('text/plain', index.toString());
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', () => {
      el.classList.remove('dragging');
    });

    el.addEventListener('dragover', (ev) => {
      ev.preventDefault();
      el.classList.add('drag-over');
    });
    el.addEventListener('dragleave', () => {
      el.classList.remove('drag-over');
    });
    el.addEventListener('drop', (ev) => {
      ev.preventDefault();
      el.classList.remove('drag-over');
      const fromIndex = parseInt(ev.dataTransfer.getData('text/plain'), 10);
      const children = Array.from(container.children);
      const toIndex = children.indexOf(el);
      if (!isNaN(fromIndex) && toIndex !== -1 && fromIndex !== toIndex) {
        moveSongInSetlist(fromIndex, toIndex);
      }
    });

    container.appendChild(el);
  });
}

/* Move an element in the DOM list representing setlist songs.
   fromIdx and toIdx are indices in the container children list.
*/
function moveSongInSetlist(fromIdx, toIdx) {
  const container = document.getElementById('setlist-songs-container');
  const children = Array.from(container.children);
  if (fromIdx < 0 || toIdx < 0 || fromIdx >= children.length || toIdx >= children.length) return;

  const node = children[fromIdx];
  // remove then re-insert
  if (fromIdx < toIdx) {
    // insert after target
    container.insertBefore(node, children[toIdx].nextSibling);
  } else {
    container.insertBefore(node, children[toIdx]);
  }

  // Re-index up/down button data-idx (optional) - simply re-render to refresh consistent state
  // Build a new songId array and re-render to refresh handlers cleanly
  const newSongIds = Array.from(container.children).map(ch => parseInt(ch.getAttribute('data-song-id')));
  renderSetlistSongs(newSongIds);
  
  // Refresh the available songs list
  renderAvailableSongs();
}

/* Add a song to the setlist editor (prevents duplicates) */
function addSongToSetlist(songId) {
  const container = document.getElementById('setlist-songs-container');
  // prevent duplicates
  if (container.querySelector(`.setlist-song-item[data-song-id="${songId}"]`)) return;
  const song = songs.find(s => s.id === songId);
  if (!song) return;

  // append existing array of song ids then re-render
  const currentIds = Array.from(container.children).map(ch => parseInt(ch.getAttribute('data-song-id')));
  currentIds.push(songId);
  renderSetlistSongs(currentIds);
  
  // Refresh the available songs list to hide the newly added song
  renderAvailableSongs();
}

/* Remove by index in the current setlist editor */
function removeSongFromSetlistIndex(idx) {
  const container = document.getElementById('setlist-songs-container');
  const children = Array.from(container.children);
  if (idx < 0 || idx >= children.length) return;
  children[idx].remove();
  
  // Refresh the available songs list to show the newly removed song
  renderAvailableSongs();
}

/* Render available songs panel (click to add). If filteredSongs provided, use it. */
function renderAvailableSongs(filteredSongs = null) {
  const container = document.getElementById('available-songs-list');
  
  // Get the current setlist song IDs
  let currentSetlistSongIds = [];
  const setlistContainer = document.getElementById('setlist-songs-container');
  if (setlistContainer) {
    currentSetlistSongIds = Array.from(setlistContainer.children).map(ch => parseInt(ch.getAttribute('data-song-id')));
  }
  
  // Filter out songs that are already in the current setlist
  let songsToRender = filteredSongs || songs;
  songsToRender = songsToRender.filter(song => !currentSetlistSongIds.includes(song.id));
  
  container.innerHTML = songsToRender.map(song => `
      <div class="available-song-item" data-song-id="${song.id}">
          <div class="song-title">${escapeHtml(song.title)}</div>
          <div class="song-details">${escapeHtml(song.key)} • ${song.bpm} bpm</div>
      </div>
  `).join('');

  // Add event listeners to add songs (click or double-click)
  document.querySelectorAll('.available-song-item').forEach(item => {
    item.addEventListener('click', () => {
      const songId = parseInt(item.getAttribute('data-song-id'));
      addSongToSetlist(songId);
    });
    // optional: support double-click to add & close
    item.addEventListener('dblclick', () => {
      const songId = parseInt(item.getAttribute('data-song-id'));
      addSongToSetlist(songId);
    });
  });
}

function editSong(song) { 
    window.fromLyricsPage = true;
    showEditSongPage(song); 
}

function saveSong() {
    const title = document.getElementById('song-title').value;
    const key = document.getElementById('song-key').value;
    const mode = document.getElementById('song-mode').value;
    const bpm = parseInt(document.getElementById('song-bpm').value);
    const timeSig = document.getElementById('song-time-sig').value;
    const lyrics = document.getElementById('song-lyrics').value;
    if (!title) { alert('Please enter a song title'); return; }
    
    // Combine key and mode for display (e.g., "C major" or "Am minor")
    const displayKey = mode === 'minor' ? key + 'm' : key;
    
    let savedSong;
    if (editingSongId) {
        const index = songs.findIndex(s => s.id === editingSongId);
        if (index !== -1) {
            songs[index] = { id: editingSongId, title, key: displayKey, bpm, timeSig, lyrics };
            savedSong = songs[index];
        }
    } else {
        const newSong = { id: Date.now(), title, key: displayKey, bpm, timeSig, lyrics };
        songs.push(newSong);
        savedSong = newSong;
    }
    
    localStorage.setItem('setlistManager_songs', JSON.stringify(songs));
    renderSongsList();
    
    // If we came from the lyrics page, go back to it
    if (window.fromLyricsPage) {
        // Update currentSong with the saved song data
        currentSong = savedSong;
        showLyricsPage(savedSong);
        window.fromLyricsPage = false;
    } else {
        showSongsPage();
    }
}

function deleteSong() {
    if (editingSongId && confirm('Are you sure you want to delete this song?')) {
        songs = songs.filter(s => s.id !== editingSongId);
        localStorage.setItem('setlistManager_songs', JSON.stringify(songs));
        renderSongsList();
        showSongsPage();
    }
}

function duplicateSong() {
    const title = document.getElementById('song-title').value;
    const key = document.getElementById('song-key').value;
    const mode = document.getElementById('song-mode').value;
    const bpm = parseInt(document.getElementById('song-bpm').value);
    const timeSig = document.getElementById('song-time-sig').value;
    const lyrics = document.getElementById('song-lyrics').value;
    if (!title) { alert('Please save the song before duplicating'); return; }
    
    // Combine key and mode for display (e.g., "C major" or "Am minor")
    const displayKey = mode === 'minor' ? key + 'm' : key;
    
    const duplicatedSong = { id: Date.now(), title: title + ' (Copy)', key: displayKey, bpm, timeSig, lyrics };
    songs.push(duplicatedSong);
    localStorage.setItem('setlistManager_songs', JSON.stringify(songs));
    renderSongsList();
    alert('Song duplicated successfully!');
}

/* ---------- metronome ---------- */
let audioContext = null;
let nextBeatTime = 0;
let metronomeBeat = 0;
let beatsPerMeasure = 4; // Default to 4/4 time
let isPlaying = false;
let scheduleTimer = null;

function toggleMetronome() {
    const metronomeBtn = document.getElementById('metronome-toggle');
    
    if (metronomeBtn.classList.contains('active')) {
        // Turn off metronome
        stopMetronome();
        metronomeBtn.classList.remove('active');
        console.log('Metronome OFF');
    } else {
        // Turn on metronome
        if (startMetronome()) {
            metronomeBtn.classList.add('active');
            console.log('Metronome ON');
        }
    }
}

function startMetronome() {
    // Need a song to play metronome for
    if (!currentSong) {
        alert('Please select a song first');
        return false;
    }
    
    // Parse time signature
    parseTimeSignature();
    
    // Create audio context if needed
    if (!audioContext) {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.error('Web Audio API is not supported in this browser', e);
            alert('Metronome is not supported in your browser');
            return false;
        }
    }
    
    // Resume audio context if suspended
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    
    // Stop any existing metronome
    stopMetronome();
    
    // Reset beat counter
    metronomeBeat = 0;
    isPlaying = true;
    
    // Set next beat time to now
    nextBeatTime = audioContext.currentTime;
    
    // Start scheduling
    scheduleBeats();
    
    return true;
}

function stopMetronome() {
    isPlaying = false;
    metronomeBeat = 0;
    if (scheduleTimer) {
        clearTimeout(scheduleTimer);
        scheduleTimer = null;
    }
}

function parseTimeSignature() {
    if (!currentSong || !currentSong.timeSig) {
        beatsPerMeasure = 4;
        return;
    }
    
    // Parse time signature like "4/4", "3/4", "6/8"
    const parts = currentSong.timeSig.split('/');
    if (parts.length === 2 && !isNaN(parts[0])) {
        beatsPerMeasure = parseInt(parts[0]);
    } else {
        beatsPerMeasure = 4; // Default fallback
    }
}

function scheduleBeats() {
    if (!isPlaying || !audioContext) return;
    
    const bpm = currentSong.bpm || 120;
    const beatInterval = 60.0 / bpm; // Time between beats in seconds
    
    // Schedule beats 100-200ms in advance
    const currentTime = audioContext.currentTime;
    const scheduleAheadTime = 0.2; // 200ms lookahead
    
    // Schedule beats until we've filled the lookahead window
    while (nextBeatTime < currentTime + scheduleAheadTime) {
        scheduleClick(nextBeatTime, metronomeBeat);
        
        // Advance to next beat
        nextBeatTime += beatInterval;
        metronomeBeat = (metronomeBeat + 1) % beatsPerMeasure;
    }
    
    // Schedule the next batch
    scheduleTimer = setTimeout(scheduleBeats, 50); // Check every 50ms
}

function scheduleClick(beatTime, beatNumber) {
    // Create the click sound to be played at the scheduled time
    createClickSound(beatTime, beatNumber);
}

function createClickSound(beatTime, beatNumber) {
    if (!audioContext) return;
    
    // Load and play the metronome sound file
    if (!metronomeBuffer) {
        console.warn('Metronome sound not loaded yet');
        // Try to create a fallback sound
        createFallbackClick(beatTime, beatNumber);
        return;
    }
    
    // Create audio nodes
    const source = audioContext.createBufferSource();
    source.buffer = metronomeBuffer;
    
    const gainNode = audioContext.createGain();
    
    // All beats sound the same with adjustable volume
    const volume = metronomeVolume / 100 * 0.8; // Scale to 0-0.8 range
    gainNode.gain.setValueAtTime(volume, beatTime);
    
    // Connect nodes: source -> gain -> destination
    source.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Play the metronome sound at the scheduled time
    source.start(beatTime);
}

function createFallbackClick(beatTime, beatNumber) {
    // Create a simple click sound as fallback
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    // All beats sound the same with adjustable volume
    oscillator.frequency.setValueAtTime(880, beatTime);
    const volume = metronomeVolume / 100 * 0.5; // Scale to 0-0.5 range
    gainNode.gain.setValueAtTime(volume, beatTime);
    
    // Quick decay
    gainNode.gain.exponentialRampToValueAtTime(0.001, beatTime + 0.05);
    
    // Connect and play
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start(beatTime);
    oscillator.stop(beatTime + 0.05);
}
</script>
</body>
</html>
